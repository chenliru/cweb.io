<html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"></head><body><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'JetBrains Mono',monospace;font-size:13.5pt;">#!/bin/ksh93<br>###########################################################################<br>#&#32;&#32;Script&#32;modified&#32;from&#32;AWS&#32;Project&#32;for&#32;B3&#32;purge&#32;by&#32;branch#&#32;and&#32;date<br>#<br>#&#32;&#32;Author&#32;:&#32;Liru&#32;Chen<br>#&#32;&#32;Date:&#32;2017-08-22<br>###########################################################################<br>#set&#32;-v<br>#set&#32;-x<br><br>DATETIME=$(date&#32;+%Y%m%d%H%M)<br><br>brno=$1<br>months=$2<br><br>if&#32;[[&#32;$#&#32;!=&#32;2&#32;]]<br>then<br>&#32;&#32;&#32;echo&#32;$"Usage:&#32;$0&#32;Branch_Number&#32;Months_To_Keep_B3"<br>&#32;&#32;&#32;exit&#32;1<br>fi<br><br>if&#32;[[&#32;$months&#32;-lt&#32;12&#32;]]<br>then<br>&#32;&#32;&#32;echo&#32;"Not&#32;permitted,&#32;You&#32;should&#32;keep&#32;at&#32;least&#32;12&#32;months&#32;B3&#32;data"<br>&#32;&#32;&#32;exit&#32;2<br>fi<br><br>BASE=/dbbkup<br>BIN=$BASE/bin<br>TMP=$BASE/tmp<br>ETC=$BASE/etc<br>LOG=$BASE/log<br><br>PATH=$BASE/bin:$PATH<br>export&#32;PATH<br><br>rootwhere="(b3.liibrchno=BRCH&#32;AND&#32;b3.approveddate&#32;like&#32;'APPROVEDMONTH')"<br>TABLE_KEY=${ETC}/table_key<br><br>#Mail&#32;address<br>amail="lchen@livingstonintl.com"<br>pmail="EKotsalainen@livingstonintl.com&#32;MStruys@livingstonintl.com&#32;lchen@livingstonintl.com"<br><br>#&#32;func_tabcolumn&#32;()&#32;{<br>&#32;&#32;&#32;#&#32;tablename=$(echo&#32;$1|tr&#32;A-Z&#32;a-z)<br>&#32;&#32;&#32;#&#32;columnsql="<br>&#32;&#32;&#32;&#32;&#32;&#32;#&#32;SELECT&#32;colname&#32;from&#32;systables,syscolumns<br>&#32;&#32;&#32;&#32;&#32;&#32;#&#32;WHERE&#32;tabname&#32;like&#32;'${tablename}'<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;#&#32;and&#32;systables.tabid=syscolumns.tabid<br>&#32;&#32;&#32;&#32;&#32;&#32;#&#32;ORDER&#32;BY&#32;colno<br>&#32;&#32;&#32;&#32;&#32;&#32;#&#32;"<br>&#32;&#32;&#32;#&#32;func_runsql&#32;"$columnsql"|grep&#32;colname|grep&#32;-v&#32;"^$"<br>#&#32;}<br><br>#&#32;#1-building&#32;select&#32;clause<br>#&#32;func_tabcolumn&#32;${chtable}&#32;|<br>#&#32;while&#32;read&#32;column&#32;columnname<br>#&#32;do<br>&#32;&#32;&#32;#&#32;selectclause="${selectclause}&#32;${chtable}.${columnname},"<br>#&#32;done<br><br>#Based&#32;on&#32;business&#32;requirement,&#32;(branch&#32;number&#32;and&#32;purged&#32;months)<br>#Build&#32;WHERE&#32;Statement,&#32;as&#32;globle&#32;variable&#32;${where_select_statement}<br>func_whereclause&#32;()&#32;{<br>&#32;&#32;&#32;b3month=18&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;#we&#32;keep&#32;18&#32;months&#32;b3&#32;data&#32;on&#32;production&#32;DB<br>&#32;&#32;&#32;((mons=b3month-months))<br><br>&#32;&#32;&#32;nums=1<br>&#32;&#32;&#32;while&#32;[[&#32;$nums&#32;-le&#32;$mons&#32;]]<br>&#32;&#32;&#32;do<br>&#32;&#32;&#32;&#32;&#32;&#32;y=$(date&#32;"+%Y")<br>&#32;&#32;&#32;&#32;&#32;&#32;m=$(date&#32;"+%m")<br><br>&#32;&#32;&#32;&#32;&#32;&#32;((m=m+nums))<br><br>&#32;&#32;&#32;&#32;&#32;&#32;if&#32;[[&#32;$m&#32;-le&#32;6&#32;]]<br>&#32;&#32;&#32;&#32;&#32;&#32;then<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;((Y=y-2))<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;((M=m+6))<br>&#32;&#32;&#32;&#32;&#32;&#32;else<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;((Y=y-1))<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;((M=m-6))<br>&#32;&#32;&#32;&#32;&#32;&#32;fi<br><br>&#32;&#32;&#32;&#32;&#32;&#32;[[&#32;${M}&#32;-lt&#32;10&#32;]]&#32;&amp;&amp;&#32;M=0${M}<br>&#32;&#32;&#32;&#32;&#32;&#32;approvedmonth=${Y}\\/${M}\\/%<br><br>&#32;&#32;&#32;&#32;&#32;&#32;wherenext=$(echo&#32;${rootwhere}|sed&#32;"s/BRCH/${brno}/")<br>&#32;&#32;&#32;&#32;&#32;&#32;wherenext=$(echo&#32;${wherenext}|sed&#32;"s/APPROVEDMONTH/${approvedmonth}/")<br><br>&#32;&#32;&#32;&#32;&#32;&#32;if&#32;[[&#32;$nums&#32;-eq&#32;1&#32;]]&#32;&#32;&#32;#handling&#32;approveddate&#32;more&#32;than&#32;one&#32;month<br>&#32;&#32;&#32;&#32;&#32;&#32;then<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;whereclause="${wherenext}"<br>&#32;&#32;&#32;&#32;&#32;&#32;else<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;whereclause="${whereclause}&#32;OR&#32;${wherenext}"<br>&#32;&#32;&#32;&#32;&#32;&#32;fi<br><br>&#32;&#32;&#32;((nums=nums+1))<br>&#32;&#32;&#32;done<br><br>&#32;&#32;&#32;rootclause="b3,b3,@b3iid,,~${whereclause}~"<br><br>&#32;&#32;&#32;echo&#32;${rootclause}<br><br>}<br><br>func_whereclause<br><br>cp&#32;${TABLE_KEY}&#32;${TABLE_KEY}.${DATETIME}<br>echo&#32;${rootclause}&#32;&gt;&#32;${TABLE_KEY}<br>grep&#32;-v&#32;"^b3,b3,@b3iid,,"&#32;${TABLE_KEY}.${DATETIME}&#32;&gt;&gt;&#32;${TABLE_KEY}<br><br>relation_data.ksh<br><br>exit&#32;0</pre></body></html>

