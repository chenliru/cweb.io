<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=UTF-8">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #FF0000;
}
.sc4 {
	font-weight: bold;
	color: #0000FF;
}
.sc5 {
	color: #808080;
}
.sc6 {
	color: #808080;
}
.sc7 {
	font-weight: bold;
	color: #804000;
}
.sc8 {
}
.sc9 {
	font-weight: bold;
	color: #FF8040;
	background: #FFFFD9;
}
.sc10 {
	color: #008080;
	background: #00FFFF;
}
.sc11 {
	font-weight: bold;
	color: #804040;
	background: #E1FFF3;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">#!/usr/bin/ksh93</span><span class="sc0">
</span><span class="sc2">#######################################################################################</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#  Filename    : tableLoad.ksh</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#  Author      : Liru Chen</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#  Description  :   </span><span class="sc0">
</span><span class="sc2">#       Load data from Production DB to DEVELOPMENT DB using no log raw table</span><span class="sc0">
</span><span class="sc2">#       1. Tables are listed in &lt;loadtables&gt;, in sequence like:</span><span class="sc0">
</span><span class="sc2">#             &lt;child-table&gt; </span><span class="sc0">
</span><span class="sc2">#             ....</span><span class="sc0">
</span><span class="sc2">#             &lt;base-table&gt;</span><span class="sc0">
</span><span class="sc2">#       2. For raw TYPE table, INDEX is OK, but No referential(foreign key), </span><span class="sc0">
</span><span class="sc2">#          or unique constraints(primary key) is allowed</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#          ALTER TABLE &lt;tablename&gt; DROP CONSTRAINT &lt;Reference name(rNum)&gt;</span><span class="sc0">
</span><span class="sc2">#          ALTER TABLE &lt;tablename&gt; DROP CONSTRAINT &lt;Primary KeyName(uNum)&gt; </span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#          notice: rNum and uNum are generated by informix</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#       3. Re-Build reference, if Failure to satisfy referential constraint</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#          DELETE FROM &lt;child-table&gt; WHERE &lt;foreign-keys&gt; NOT IN</span><span class="sc0">
</span><span class="sc2">#          (SELECT &lt;foreign-keys&gt; FROM &lt;base-table&gt;)</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#          or, you may need following when table is so huge or reference condition</span><span class="sc0">
</span><span class="sc2">#          is complex,</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#          DELETE FROM &lt;child-table&gt;</span><span class="sc0">
</span><span class="sc2">#          WHERE 0 = (SELECT COUNT(*) FROM &lt;base-table&gt;</span><span class="sc0">
</span><span class="sc2">#          WHERE &lt;child-table&gt;.key1 = &lt;base-table&gt;.key1</span><span class="sc0">
</span><span class="sc2">#          AND &lt;child-table&gt;.key2 = &lt;base-table&gt;.key2);</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#       4. ENABLE ALL the index,constraint and trigger, and double check their status</span><span class="sc0">
</span><span class="sc2">#</span><span class="sc0">
</span><span class="sc2">#  Date : 2015-05-15</span><span class="sc0">
</span><span class="sc2">#                </span><span class="sc0">
</span><span class="sc2">########################################################################################</span><span class="sc0">
</span><span class="sc4">set</span><span class="sc0"> </span><span class="sc8">-x</span><span class="sc0">
</span><span class="sc4">set</span><span class="sc0"> </span><span class="sc7">-</span><span class="sc8">v</span><span class="sc0">

</span><span class="sc2"># tableName</span><span class="sc0">
</span><span class="sc8">loadDir</span><span class="sc7">=/</span><span class="sc8">usr</span><span class="sc7">/</span><span class="sc8">local</span><span class="sc7">/</span><span class="sc8">dbbkup</span><span class="sc0">
</span><span class="sc8">tableList</span><span class="sc7">=</span><span class="sc9">$loadDir</span><span class="sc7">/</span><span class="sc8">stage</span><span class="sc7">/</span><span class="sc8">loadtables</span><span class="sc0">

</span><span class="sc8">DATABASESVR</span><span class="sc7">=</span><span class="sc8">systestdb</span><span class="sc0">
</span><span class="sc8">DATABASE</span><span class="sc7">=</span><span class="sc8">ip_systest</span><span class="sc7">@</span><span class="sc8">systestdb</span><span class="sc0">

</span><span class="sc8">tableNames</span><span class="sc7">=(</span><span class="sc11">$(cat $tableList)</span><span class="sc7">)</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc7">=</span><span class="sc10">${#tableNames[@]}</span><span class="sc0">
</span><span class="sc2">#currentDate=$(date +%Y%m%d)</span><span class="sc0">
</span><span class="sc8">currentDate</span><span class="sc7">=</span><span class="sc3">20150517</span><span class="sc0">

</span><span class="sc2">#setup Database environment</span><span class="sc0">
</span><span class="sc7">.</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">login</span><span class="sc7">/</span><span class="sc8">lchen</span><span class="sc7">/</span><span class="sc8">ids115.env</span><span class="sc0"> </span><span class="sc9">$DATABASESVR</span><span class="sc0">
</span><span class="sc4">cd</span><span class="sc0"> </span><span class="sc9">$loadDir</span><span class="sc7">/</span><span class="sc8">sql</span><span class="sc0">

</span><span class="sc2">#Phase I: Collect CONSTRAINTS,INDEXES,TRIGGERS, and compose SQL </span><span class="sc0">
</span><span class="sc8">sql</span><span class="sc0"> </span><span class="sc7">()</span><span class="sc0"> </span><span class="sc7">{</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc3">0</span><span class="sc0">


</span><span class="sc4">while</span><span class="sc0"> </span><span class="sc7">((</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc0"> </span><span class="sc7">&lt;</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc0"> </span><span class="sc7">))</span><span class="sc0">
</span><span class="sc4">do</span><span class="sc0"> 
    </span><span class="sc2"># clear SQL statement if exist</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">DDL_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createindex_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">dropindex_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createtrigger_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">droptrigger_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createreference_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">dropreference_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createprimarykey_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">cat</span><span class="sc0"> </span><span class="sc7">/</span><span class="sc8">dev</span><span class="sc7">/</span><span class="sc8">null</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">dropprimarykey_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">

    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">DDL_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    
    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc7">|</span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{printf $0} /;/{print ""}'</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">egrep</span><span class="sc0"> </span><span class="sc5">"create.index"</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createindex_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">    
    
    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc7">|</span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{printf $0} /;/{print ""}'</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">egrep</span><span class="sc0"> </span><span class="sc5">"create.index"</span><span class="sc7">|</span><span class="sc4">sed</span><span class="sc0"> </span><span class="sc8">s</span><span class="sc7">/</span><span class="sc8">create</span><span class="sc7">/</span><span class="sc8">drop</span><span class="sc7">/|</span><span class="sc0">
    </span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{print $1" "$2" "$3}'</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">dropindex_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">    

    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc7">|</span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{printf $0} /;/{print ""}'</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">egrep</span><span class="sc0"> </span><span class="sc5">"create.trigger"</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createtrigger_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    
    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc7">|</span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{printf $0} /;/{print ""}'</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">egrep</span><span class="sc0"> </span><span class="sc5">"create.trigger"</span><span class="sc7">|</span><span class="sc4">sed</span><span class="sc0"> </span><span class="sc8">s</span><span class="sc7">/</span><span class="sc8">create</span><span class="sc7">/</span><span class="sc8">drop</span><span class="sc7">/|</span><span class="sc0">
    </span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{print $1" "$2" "$3}'</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">droptrigger_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">

    </span><span class="sc8">dbschema</span><span class="sc0"> </span><span class="sc8">-d</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">-t</span><span class="sc0"> </span><span class="sc10">${tableNames[$i]}</span><span class="sc7">|</span><span class="sc4">awk</span><span class="sc0"> </span><span class="sc6">'{printf $0} /;/{print ""}'</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">egrep</span><span class="sc0"> </span><span class="sc5">"alter.table"</span><span class="sc0"> </span><span class="sc7">&gt;</span><span class="sc0"> </span><span class="sc8">createreference_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
        
    </span><span class="sc8">primarykn</span><span class="sc7">=</span><span class="sc11">$(dbschema -d $DATABASE -t ${tableNames[$i]}|grep -i "primary key")</span><span class="sc0"> 
    </span><span class="sc7">[[</span><span class="sc0"> </span><span class="sc9">$primarykn</span><span class="sc0"> </span><span class="sc7">!=</span><span class="sc0"> </span><span class="sc5">""</span><span class="sc0"> </span><span class="sc7">]]</span><span class="sc0"> </span><span class="sc7">&amp;&amp;</span><span class="sc0"> </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"ALTER TABLE ${tableNames[$i]} ADD CONSTRAINT $primarykn;
    "</span><span class="sc0"> </span><span class="sc7">&gt;&gt;</span><span class="sc0"> </span><span class="sc8">createprimarykey_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
                
    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    SELECT constrname FROM  sysconstraints
    WHERE tabid = (SELECT tabid FROM systables
    WHERE tabname = '${tableNames[$i]}');
    "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0"> </span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">while</span><span class="sc0"> </span><span class="sc4">read</span><span class="sc0"> </span><span class="sc8">col1</span><span class="sc0"> </span><span class="sc8">cname</span><span class="sc0">
    </span><span class="sc4">do</span><span class="sc0">
        </span><span class="sc8">referencen</span><span class="sc7">=</span><span class="sc11">$(echo $cname | grep ^r)</span><span class="sc0">
        </span><span class="sc7">[[</span><span class="sc0"> </span><span class="sc9">$referencen</span><span class="sc0"> </span><span class="sc7">!=</span><span class="sc0"> </span><span class="sc5">""</span><span class="sc0"> </span><span class="sc7">]]</span><span class="sc0"> </span><span class="sc7">&amp;&amp;</span><span class="sc0"> </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"ALTER TABLE ${tableNames[$i]} DROP CONSTRAINT $referencen 
        ;"</span><span class="sc0"> </span><span class="sc7">&gt;&gt;</span><span class="sc0"> </span><span class="sc8">dropreference_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    
        </span><span class="sc8">primaryn</span><span class="sc7">=</span><span class="sc11">$(echo $cname | grep ^u)</span><span class="sc0">
        </span><span class="sc7">[[</span><span class="sc0"> </span><span class="sc9">$primaryn</span><span class="sc0"> </span><span class="sc7">!=</span><span class="sc0"> </span><span class="sc5">""</span><span class="sc0"> </span><span class="sc7">]]</span><span class="sc0"> </span><span class="sc7">&amp;&amp;</span><span class="sc0"> </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"ALTER TABLE ${tableNames[$i]} DROP CONSTRAINT $primaryn 
        ;"</span><span class="sc0"> </span><span class="sc7">&gt;&gt;</span><span class="sc0"> </span><span class="sc8">dropprimarykey_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc4">done</span><span class="sc0">
    
    </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc8">i+1</span><span class="sc0">
</span><span class="sc4">done</span><span class="sc0">
</span><span class="sc7">}</span><span class="sc0">

</span><span class="sc2"># Phase II: TRUNCATE TABLE, unload data for rollback if needed</span><span class="sc0">
</span><span class="sc8">truncate</span><span class="sc0"> </span><span class="sc7">()</span><span class="sc0"> </span><span class="sc7">{</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc3">0</span><span class="sc0">
</span><span class="sc4">while</span><span class="sc0"> </span><span class="sc7">((</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc0"> </span><span class="sc7">&lt;</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc0"> </span><span class="sc7">))</span><span class="sc0">
</span><span class="sc4">do</span><span class="sc0"> 
    </span><span class="sc2">##uncomment unload if data in table is very important for rollback consideration</span><span class="sc0">
    </span><span class="sc2">#echo "</span><span class="sc0">
    </span><span class="sc2">#UNLOAD TO "$loadDir/sql/${tableNames[$i]}.$currentDate" \
    #SELECT * FROM ${tableNames[$i]}" |\
    #$INFORMIXDIR/bin/dbaccess $DATABASE</span><span class="sc0">

    </span><span class="sc2">#It's convenient in operations to disable constraint,index and trigger</span><span class="sc0">
    </span><span class="sc2">#where you intend to LOAD or TRUNCATE all the data in a table, </span><span class="sc0">
    </span><span class="sc2">#or to consolidate the free space in a table</span><span class="sc0">
    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    SET CONSTRAINTS,INDEXES,TRIGGERS FOR ${tableNames[$i]} DISABLED; "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> 

    </span><span class="sc2">#Truncating a table with delete trigger requires ALTER privilege.   </span><span class="sc0">
    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    TRUNCATE ${tableNames[$i]}; "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> 
    
</span><span class="sc8">i</span><span class="sc7">=</span><span class="sc8">i+1</span><span class="sc0">
</span><span class="sc4">done</span><span class="sc0">
</span><span class="sc7">}</span><span class="sc0">

</span><span class="sc2"># Phase III: DROP PRIMARY INDEXES &amp; CONSTRAINTS, ALTER TYPE(RAW)</span><span class="sc0">
</span><span class="sc8">raw</span><span class="sc0"> </span><span class="sc7">()</span><span class="sc0"> </span><span class="sc7">{</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc3">0</span><span class="sc0">

</span><span class="sc4">while</span><span class="sc0"> </span><span class="sc7">((</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc0"> </span><span class="sc7">&lt;</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc0"> </span><span class="sc7">))</span><span class="sc0">
</span><span class="sc4">do</span><span class="sc0"> 
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">dropprimarykey_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">dropreference_</span><span class="sc10">${tableNames[$i]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">

    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
        ALTER TABLE ${tableNames[$i]} TYPE(RAW); "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
        </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0">
    
</span><span class="sc8">i</span><span class="sc7">=</span><span class="sc8">i+1</span><span class="sc0">
</span><span class="sc4">done</span><span class="sc0">
</span><span class="sc7">}</span><span class="sc0">

</span><span class="sc2"># Phase IV: LOAD TABLE</span><span class="sc0">
</span><span class="sc8">load</span><span class="sc0"> </span><span class="sc7">()</span><span class="sc0"> </span><span class="sc7">{</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc3">0</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">j</span><span class="sc7">=</span><span class="sc8">summ</span><span class="sc0">

</span><span class="sc4">while</span><span class="sc0"> </span><span class="sc7">((</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc0"> </span><span class="sc7">&lt;</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc0"> </span><span class="sc7">))</span><span class="sc0">
</span><span class="sc4">do</span><span class="sc0"> 
    </span><span class="sc8">j</span><span class="sc7">=</span><span class="sc8">j-1</span><span class="sc0">
    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    LOAD FROM $loadDir/stage/${tableNames[$j]}.$currentDate 
    INSERT INTO ${tableNames[$j]}"</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0"> 
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc4">grep</span><span class="sc0"> </span><span class="sc7">-</span><span class="sc8">i</span><span class="sc0"> </span><span class="sc8">error</span><span class="sc0">

    </span><span class="sc2">#[[ $? -ne 0 ]] &amp;&amp; mv $loadDir/stage/${tableNames[$j]}.$currentDate $loadDir/done</span><span class="sc0">
    
</span><span class="sc8">i</span><span class="sc7">=</span><span class="sc8">i+1</span><span class="sc0">
</span><span class="sc4">done</span><span class="sc0">
</span><span class="sc7">}</span><span class="sc0">

</span><span class="sc2"># Phase V: ALTER TABLE TYPE(STANDARD), Re-Build INDEXES, CONSTRAINTS, TRIGGERS</span><span class="sc0">
</span><span class="sc8">standard</span><span class="sc0"> </span><span class="sc7">()</span><span class="sc0"> </span><span class="sc7">{</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc7">=</span><span class="sc3">0</span><span class="sc0">
</span><span class="sc4">integer</span><span class="sc0"> </span><span class="sc8">j</span><span class="sc7">=</span><span class="sc8">summ</span><span class="sc0">

</span><span class="sc4">while</span><span class="sc0"> </span><span class="sc7">((</span><span class="sc0"> </span><span class="sc8">i</span><span class="sc0"> </span><span class="sc7">&lt;</span><span class="sc0"> </span><span class="sc8">summ</span><span class="sc0"> </span><span class="sc7">))</span><span class="sc0">
</span><span class="sc4">do</span><span class="sc0"> 
    </span><span class="sc8">j</span><span class="sc7">=</span><span class="sc8">j-1</span><span class="sc0">
    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    ALTER TABLE ${tableNames[$j]} TYPE(STANDARD); "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0">
    
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">createprimarykey_</span><span class="sc10">${tableNames[$j]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> </span><span class="sc8">createreference_</span><span class="sc10">${tableNames[$j]}</span><span class="sc7">.</span><span class="sc8">sql</span><span class="sc0">

    </span><span class="sc4">echo</span><span class="sc0"> </span><span class="sc5">"
    SET CONSTRAINTS,INDEXES,TRIGGERS FOR ${tableNames[$j]} ENABLED; "</span><span class="sc0"> </span><span class="sc7">|</span><span class="sc0">
    </span><span class="sc9">$INFORMIXDIR</span><span class="sc7">/</span><span class="sc8">bin</span><span class="sc7">/</span><span class="sc8">dbaccess</span><span class="sc0"> </span><span class="sc9">$DATABASE</span><span class="sc0"> 
    </span><span class="sc2">#Double check INDEX,CONSTRAINT and TRIGGERS status are all ENABLED</span><span class="sc0">
    </span><span class="sc2">#in the sysobjstate system catalog table with status 'E'</span><span class="sc0">
    
</span><span class="sc8">i</span><span class="sc7">=</span><span class="sc8">i+1</span><span class="sc0">
</span><span class="sc4">done</span><span class="sc0">
</span><span class="sc7">}</span><span class="sc0">

</span><span class="sc2">#sql</span><span class="sc0">
</span><span class="sc2">#truncate</span><span class="sc0">
</span><span class="sc2">#raw</span><span class="sc0">
</span><span class="sc2">#load</span><span class="sc0">
</span><span class="sc8">standard</span><span class="sc0">

</span><span class="sc4">exit</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0">



</span></div></body>
</html>
